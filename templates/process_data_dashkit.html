{% extends "base_dashkit.html" %}

{% block title %}Xử Lý Dữ Liệu | Dashboard Phân Cụm{% endblock %}

{% block header %}Xử Lý Dữ Liệu{% endblock %}

{% block content %}
<div class="alert-container">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<div class="row">
    <!-- Sidebar với các tùy chọn -->
    <div class="col-md-3">
        <!-- Card: Thông tin dữ liệu -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-info-circle me-2 text-info"></i>Thông Tin Dữ Liệu
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Số dòng
                        <span class="badge bg-primary rounded-pill">{{ data.num_rows if data.num_rows else 0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tổng feature
                        <span class="badge bg-primary rounded-pill">{{ data.num_features if data.num_features else 0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Feature số
                        <span class="badge bg-success rounded-pill">{{ data.numeric_columns|length if data.numeric_columns else 0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Feature khác
                        <span class="badge bg-info rounded-pill">{{ data.non_numeric_columns|length if data.non_numeric_columns else 0 }}</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Card: Quy trình -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-tasks me-2 text-primary"></i>Quy Trình
                </h5>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex align-items-center">
                        <span class="badge rounded-pill bg-success me-2">1</span> Tải dữ liệu
                        <i class="fas fa-check-circle text-success ms-auto"></i>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                        <span class="badge rounded-pill bg-success me-2">2</span> Xem dữ liệu
                        <i class="fas fa-check-circle text-success ms-auto"></i>
                    </li>
                    <li class="list-group-item d-flex align-items-center active">
                        <span class="badge rounded-pill bg-primary me-2">3</span> <strong>Xử lý dữ liệu</strong>
                        <i class="fas fa-arrow-right text-primary ms-auto"></i>
                    </li>
                    <li class="list-group-item d-flex align-items-center text-muted">
                        <span class="badge rounded-pill bg-secondary me-2">4</span> Chọn mô hình
                        {% if data.proceed_to_model %}
                            <a href="{{ url_for('select_model') }}" class="ms-auto"><i class="fas fa-arrow-right"></i></a>
                        {% else %}
                            <i class="fas fa-lock ms-auto"></i>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex align-items-center text-muted">
                        <span class="badge rounded-pill bg-secondary me-2">5</span> Phân tích BCVI
                        <i class="fas fa-lock ms-auto"></i>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Nội dung chính -->
    <div class="col-md-9">
        <!-- Card: Chọn Feature -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title">
                    <i class="fas fa-list-check me-2 text-success"></i>Chọn Feature
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="featureForm">
                    <input type="hidden" name="action" value="select_features">
                    
                    <div class="mb-3">
                        <label class="form-label">Tùy chọn feature:</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" id="feature_default" name="feature_option" value="default" checked>
                            <label class="form-check-label" for="feature_default">Sử dụng feature mặc định</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" id="feature_custom" name="feature_option" value="custom">
                            <label class="form-check-label" for="feature_custom">Tùy chọn feature</label>
                        </div>
                    </div>
                    
                    {% if data.numerical_features %}
                        <div class="mb-3 feature-checkboxes d-none" id="featureCheckboxes">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Chọn feature: <span id="selectedCount" class="badge bg-secondary ms-2">Đã chọn: {{ data.selected_features|length }}</span></label>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="resetFeatures">
                                    <i class="fas fa-undo me-1"></i>Đặt lại
                                </button>
                            </div>
                            
                            <div class="row">
                                {% for feature in data.numerical_features %}
                                    <div class="col-md-4 col-6 mb-2">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input feature-checkbox" 
                                                   name="features" value="{{ feature }}" id="feature_{{ loop.index }}"
                                                   {% if feature in data.selected_features %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_{{ loop.index }}">
                                                {{ feature }}
                                                {% if feature in data.numeric_columns %}
                                                    <small class="text-muted">(số)</small>
                                                {% else %}
                                                    <small class="text-muted">(khác)</small>
                                                {% endif %}
                                                {% if data.default_features and feature in data.default_features %}
                                                    <small class="text-success">(mặc định)</small>
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Không tìm thấy feature. Vui lòng tải lên dữ liệu trước.
                        </div>
                    {% endif %}
                    
                    <!-- Thêm lựa chọn sử dụng PCA hay không -->
                    <div class="mb-3 mt-3 border p-3 rounded bg-light">
                        <label class="form-label fw-bold">Phương pháp xử lý dữ liệu:</label>
                        <div class="form-check mt-2">
                            <input type="radio" class="form-check-input" id="use_pca_yes" name="use_pca" value="yes" {% if data.use_pca %}checked{% endif %}>
                            <label class="form-check-label" for="use_pca_yes">
                                <span class="text-primary"><i class="fas fa-compress-arrows-alt me-1"></i>Sử dụng PCA</span> để giảm chiều dữ liệu
                            </label>
                            <div class="form-text ms-4 mt-1">
                                <i class="fas fa-info-circle me-1 text-info"></i>Phù hợp khi có nhiều features tương quan với nhau, giúp giảm số lượng biến cần xét.
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="radio" class="form-check-input" id="use_pca_no" name="use_pca" value="no" {% if not data.use_pca %}checked{% endif %}>
                            <label class="form-check-label" for="use_pca_no">
                                <span class="text-success"><i class="fas fa-vector-square me-1"></i>Sử dụng trực tiếp</span> các feature đã chọn
                            </label>
                            <div class="form-text ms-4 mt-1">
                                <i class="fas fa-info-circle me-1 text-info"></i>Phù hợp khi muốn giữ nguyên ý nghĩa của từng feature. Bỏ qua bước PCA và chuyển thẳng đến bước chọn mô hình.
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check-circle me-1"></i>Chọn Feature
                    </button>
                </form>
            </div>
        </div>

        {% if not data.use_pca and data.selected_features %}
            <!-- Card: Thông báo PCA bị bỏ qua -->
            <div class="card mb-4" id="skip-pca-card">
                <div class="card-header bg-light">
                    <h5 class="card-title">
                        <i class="fas fa-check-double me-2 text-success"></i>Xử lý dữ liệu hoàn tất
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Đã bỏ qua PCA!</strong> Sẽ sử dụng trực tiếp {{ data.selected_features|length }} features đã chọn cho phân cụm.
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-list-ul me-2 text-success"></i>Feature đã chọn:</h6>
                                    <div>
                                        {% for feature in data.selected_features %}
                                            <span class="badge bg-light text-dark border mb-1 me-1">{{ feature }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-info-circle me-2 text-info"></i>Lưu ý:</h6>
                                    <p class="card-text small">Khi <strong>không sử dụng PCA</strong>, mô hình sẽ phân cụm dựa trên các features gốc đã chọn. Điều này giúp kết quả phân cụm dễ diễn giải hơn, tuy nhiên có thể chịu ảnh hưởng của nhiễu hoặc tương quan giữa các biến.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center mt-4">
                        <a href="{{ url_for('select_model') }}" class="btn btn-lg btn-success">
                            <i class="fas fa-arrow-right me-2"></i>Tiếp tục với bước Chọn Mô hình
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Card: Thực hiện phân tích -->
        <div class="card" id="pca-card" {% if not data.use_pca %}style="display: none;"{% endif %}>
            <div class="card-header bg-light">
                <h5 class="card-title">
                    <i class="fas fa-chart-line me-2 text-warning"></i>Thực hiện PCA
                </h5>
            </div>
            <div class="card-body">
                {% if data.selected_features %}
                    <div class="mb-4">
                        <h6 class="mb-2">Feature đã chọn ({{ data.selected_features|length }}):</h6>
                        <div>
                            {% for feature in data.selected_features %}
                                <span class="badge bg-info text-dark mb-1 me-1">{{ feature }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <form method="post" id="analysisForm">
                        <input type="hidden" name="action" value="perform_pca">
                        
                        <div class="mb-3">
                            <label for="explained_variance_ratio" class="form-label">
                                <i class="fas fa-percentage me-2"></i>Tỷ lệ phương sai giải thích (%):
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="explained_variance_ratio" 
                                       name="explained_variance_ratio" value="90" min="1" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">
                                Giá trị cao hơn sẽ giữ lại nhiều thông tin hơn nhưng có nhiều thành phần chính hơn.
                            </div>
                        </div>
                        
                        <!-- Quick select buttons -->
                        <div class="mb-3">
                            <label class="form-label">Hoặc chọn nhanh:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm quick-variance" data-value="80">80%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm quick-variance" data-value="85">85%</button>
                                <button type="button" class="btn btn-outline-primary btn-sm quick-variance" data-value="90">90%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm quick-variance" data-value="95">95%</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm quick-variance" data-value="99">99%</button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-play me-2"></i>Thực hiện PCA
                        </button>
                    </form>
                    
                    <div class="progress mt-3 d-none" id="analysisProgress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Vui lòng chọn feature trước khi thực hiện PCA.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Card: Kết quả PCA (nếu có) -->
        {% if data.pca_result %}
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Kết quả PCA
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">{{ data.pca_result.n_components }}</h3>
                                    <p class="mb-0">Thành phần chính</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h3 class="text-success">{{ "%.1f"|format(data.pca_result.explained_variance_ratio * 100) }}%</h3>
                                    <p class="mb-0">Phương sai giải thích</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h3 class="text-info">{{ data.pca_result.original_features|length }}</h3>
                                    <p class="mb-0">Features gốc</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h3 class="text-warning">{{ "%.1f"|format(data.pca_result.target_variance * 100) }}%</h3>
                                    <p class="mb-0">Mục tiêu đặt ra</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if data.pca_result.pca_plot %}
                        <div class="mt-4">
                            <h6>Biểu đồ Phương sai PCA (Dashboard Cũ)</h6>
                            <div class="text-center">
                                <img src="data:image/png;base64,{{ data.pca_result.pca_plot }}" 
                                     class="img-fluid rounded" 
                                     alt="PCA Variance Plot" 
                                     style="max-width: 100%; height: auto; border: 1px solid #ddd;">
                            </div>
                        </div>
                    {% endif %}

                    <!-- Bảng chi tiết phương sai -->
                    {% if data.pca_result.variance_details %}
                        <div class="mt-4">
                            <h6>Chi tiết phương sai của từng thành phần</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Thành phần</th>
                                            <th>Tỷ lệ phương sai (%)</th>
                                            <th>Phương sai tích lũy (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detail in data.pca_result.variance_details %}
                                            <tr>
                                                <td>{{ detail.component }}</td>
                                                <td>{{ detail.variance_ratio|round(2) }}</td>
                                                <td>{{ (detail.cumulative_variance * 100)|round(2) }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Biểu đồ Scree Plot -->
                    {% if data.pca_result.scree_plot %}
                        <div class="mt-4">
                            <h6>Biểu đồ Scree Plot</h6>
                            <div id="screePlot"></div>
                        </div>
                    {% endif %}
                    
                    <!-- Biểu đồ PCA 2D -->
                    {% if data.pca_result.pca_2d_plot %}
                        <div class="mt-4">
                            <h6>Biểu đồ PCA 2D</h6>
                            <div id="pca2dPlot"></div>
                        </div>
                    {% endif %}
                    
                    <!-- Nút tiếp tục -->
                    <div class="text-center mt-4">
                        <a href="{{ url_for('select_model') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>Tiếp tục đến Chọn mô hình
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Danh sách feature mặc định với giá trị mặc định rỗng
    const defaultFeatures = {{ data.default_features|tojson|default([])|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        // Feature option handling
        const featureDefault = document.getElementById('feature_default');
        const featureCustom = document.getElementById('feature_custom');
        const featureCheckboxes = document.getElementById('featureCheckboxes');
        const featureForm = document.getElementById('featureForm');
        const allFeatureCheckboxes = document.querySelectorAll('.feature-checkbox');
        const selectedCount = document.getElementById('selectedCount');
        
        function updateSelectedCount() {
            if (selectedCount) {
                const count = [...allFeatureCheckboxes].filter(cb => cb.checked).length;
                selectedCount.textContent = `Đã chọn: ${count}`;
            }
        }

        function syncCheckboxesToDefault() {
            // Xóa tất cả checkbox trước khi đồng bộ
            allFeatureCheckboxes.forEach(function(checkbox) {
                checkbox.checked = defaultFeatures.includes(checkbox.value);
            });
            updateSelectedCount();
        }

        if (featureDefault && featureCustom && featureCheckboxes) {
            // Đồng bộ checkbox khi tải trang nếu ở chế độ mặc định
            if (featureDefault.checked) {
                syncCheckboxesToDefault();
                featureCheckboxes.classList.add('d-none');
            } else {
                featureCheckboxes.classList.remove('d-none');
            }

            featureDefault.addEventListener('change', function() {
                if (this.checked) {
                    featureCheckboxes.classList.add('d-none');
                    syncCheckboxesToDefault();
                }
            });
            
            featureCustom.addEventListener('change', function() {
                if (this.checked) {
                    featureCheckboxes.classList.remove('d-none');
                }
            });
            
            // Kiểm tra nếu đã có feature được chọn và không ở chế độ default
            if (allFeatureCheckboxes.length > 0 && !featureDefault.checked) {
                featureCustom.checked = true;
                featureCheckboxes.classList.remove('d-none');
            }
        }

        // Xử lý khi submit form
        if (featureForm) {
            featureForm.addEventListener('submit', function() {
                if (featureDefault.checked) {
                    syncCheckboxesToDefault();
                }
            });
        }

        // Reset features button
        const resetButton = document.getElementById('resetFeatures');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                allFeatureCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
                updateSelectedCount();
            });
        }
        
        allFeatureCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', updateSelectedCount);
        });

        updateSelectedCount();
        
        // Analysis form
        const analysisForm = document.getElementById('analysisForm');
        const analysisProgress = document.getElementById('analysisProgress');
        
        if (analysisForm && analysisProgress) {
            analysisForm.addEventListener('submit', function() {
                analysisProgress.classList.remove('d-none');
            });
        }
        
        // Quick variance selection
        const quickVarianceButtons = document.querySelectorAll('.quick-variance');
        const varianceInput = document.getElementById('explained_variance_ratio');
        
        quickVarianceButtons.forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                varianceInput.value = value;
                
                quickVarianceButtons.forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-secondary');
                });
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-primary');
            });
        });
        
        // Render Plotly charts
        {% if data.pca_result and data.pca_result.scree_plot %}
            const screePlotData = {{ data.pca_result.scree_plot|safe }};
            Plotly.newPlot('screePlot', screePlotData.data, screePlotData.layout);
        {% endif %}
        {% if data.pca_result and data.pca_result.pca_2d_plot %}
            const pca2dPlotData = {{ data.pca_result.pca_2d_plot|safe }};
            Plotly.newPlot('pca2dPlot', pca2dPlotData.data, pca2dPlotData.layout);
        {% endif %}

        // Toggle PCA card visibility based on radio button
        document.getElementById('use_pca_yes').addEventListener('change', function() {
            const pcaCard = document.getElementById('pca-card');
            if (pcaCard) pcaCard.style.display = 'block';
            
            const skipPcaCard = document.getElementById('skip-pca-card');
            if (skipPcaCard) skipPcaCard.style.display = 'none';
        });
        
        document.getElementById('use_pca_no').addEventListener('change', function() {
            const pcaCard = document.getElementById('pca-card');
            if (pcaCard) pcaCard.style.display = 'none';
            
            const skipPcaCard = document.getElementById('skip-pca-card');
            if (skipPcaCard) skipPcaCard.style.display = 'block';
        });
        
        // Initialize visibility based on selected radio
        if (document.getElementById('use_pca_no').checked) {
            const pcaCard = document.getElementById('pca-card');
            if (pcaCard) pcaCard.style.display = 'none';
            
            const skipPcaCard = document.getElementById('skip-pca-card');
            if (skipPcaCard) skipPcaCard.style.display = 'block';
        } else {
            const skipPcaCard = document.getElementById('skip-pca-card');
            if (skipPcaCard) skipPcaCard.style.display = 'none';
        }
    });
</script>
{% endblock %}